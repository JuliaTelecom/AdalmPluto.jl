include("Pluto.jl");
using .Pluto


function toComplexFloat(x)
    T = Float32;
    return reinterpret(Complex{T},convert.(T,x));
end
function main()
carrierFreq = 300e6;
samplingRate     = 4e6;
gain    = 50;

global plutoSDR = openPluto(carrierFreq,samplingRate,gain;antenna="RX2",ip="auto")

freq = updateCarrierFreq!(plutoSDR,2400e6);
@show freq
freq = updateCarrierFreq!(plutoSDR,868e6);

newSamp = updateSamplingRate!(plutoSDR.rx,5.333e6);
# newSamp = updateSamplingRate!(plutoSDR,8e6);

print(plutoSDR)


sig = recv(plutoSDR,1024);

close(plutoSDR)

return sig;
end


using Plots;
using GetSpectrum
gr();
function trySpectrum()
    carrierFreq         = 2480e6;
    samplingRate        = 16e6;
    gain                = 50;
    
    global plutoSDR = openPluto(carrierFreq,samplingRate,gain;antenna="RX2",ip="auto")
    print(plutoSDR);
    try 
        while (true)
            sig = recv(plutoSDR,plutoSDR.rx.packetSize) |> toComplexFloat;
            getSpectrum(1,sig) |> plot |> display;
        end
    catch exception;
        @info "Stopping script"
    close(plutoSDR)
    rethrow(exception)
    end 
end